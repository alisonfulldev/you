<section class="payment">
  <div class="card">
    <h2>Gerar Certificado</h2>
    <p class="muted">
      <% if (typeof scorePercent !== 'undefined') { %>
        Você foi aprovado com <strong><%= scorePercent %>%</strong>. Conclua o pagamento para gerar seu certificado.
      <% } else { %>
        Conclua o pagamento para gerar seu certificado.
      <% } %>
    </p>
    <div class="pay-actions">
      <% if (typeof examId === 'undefined') { %>
        <div class="form-grid" style="margin-bottom:12px;">
          <input type="text" id="student_name" placeholder="Seu nome" />
          <input type="email" id="student_email" placeholder="Seu e-mail" />
        </div>
      <% } %>
      <div class="form-grid" style="margin-bottom:12px;">
        <input type="text" id="display_student_name" placeholder="Nome no certificado (opcional)" />
        <input type="text" id="display_course_title" placeholder="Nome do curso no certificado (opcional)" />
      </div>
      <div class="row" style="gap:8px;">
        <button class="btn gradient large" id="payStripe">Pagar com Stripe</button>
        <button class="btn pill large" id="payMP">Pagar com Mercado Pago</button>
        <button class="btn ghost large" id="previewCert">Gerar certificado (Teste – sem pagamento)</button>
      </div>
    </div>
  </div>
</section>
<script>
  document.getElementById('payStripe').addEventListener('click', async () => {
    <% if (typeof examId !== 'undefined') { %>
    const res = await fetch('/payment/create', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ examId: <%= examId %> })
    });
    <% } else { %>
    const name = document.getElementById('student_name').value.trim();
    const email = document.getElementById('student_email').value.trim();
    if (!name || !email) { alert('Informe nome e e-mail'); return; }
    const res = await fetch('/payment/create-direct', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ courseId: <%= course.id %>, student_name: name, student_email: email })
    });
    <% } %>
    const data = await res.json();
    if (data.url) { window.location.href = data.url; }
  });

  document.getElementById('payMP').addEventListener('click', async () => {
    <% if (typeof examId !== 'undefined') { %>
    const res = await fetch('/payment/create-mp', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ examId: <%= examId %> })
    });
    <% } else { %>
    const name = document.getElementById('student_name').value.trim();
    const email = document.getElementById('student_email').value.trim();
    if (!name || !email) { alert('Informe nome e e-mail'); return; }
    const res = await fetch('/payment/create-direct-mp', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ courseId: <%= course.id %>, student_name: name, student_email: email })
    });
    <% } %>
    const data = await res.json();
    if (data.url) { window.location.href = data.url; }
  });

  document.getElementById('previewCert').addEventListener('click', async () => {
    let name = 'Aluno Teste';
    let email = `teste+${Date.now()}@example.com`;
    const nameEl = document.getElementById('student_name');
    const emailEl = document.getElementById('student_email');
    if (nameEl && emailEl) {
      name = nameEl.value.trim() || name;
      email = emailEl.value.trim() || email;
    }
    const displayName = (document.getElementById('display_student_name').value || '').trim();
    const displayCourse = (document.getElementById('display_course_title').value || '').trim();
    const res = await fetch('/certificate/preview', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ courseId: <%= course.id %>, student_name: name, student_email: email, scorePercent: <%= typeof scorePercent !== 'undefined' ? scorePercent : 100 %>, display_student_name: displayName, display_course_title: displayCourse })
    });
    const data = await res.json();
    if (data.validateUrl) { window.location.href = data.validateUrl; }
    else if (data.pdfUrl) { window.location.href = data.pdfUrl; }
    else { alert('Não foi possível gerar o certificado de teste.'); }
  });
</script>