<section class="payment">
  <div class="card">
    <h2>Gerar Certificado</h2>
    <p class="muted">
      Conclua o curso e finalize o pagamento para gerar seu certificado.
    </p>
    <div class="grid" style="display:grid;grid-template-columns:1fr;gap:8px;margin:10px 0 16px;">
      <label style="display:block">Nome completo</label>
      <input class="input" id="student_name" placeholder="Seu nome" />
      <label style="display:block">E-mail</label>
      <input class="input" id="student_email" placeholder="voce@exemplo.com" type="email" />
    </div>
    <div class="pay-actions">
      
      
      <div class="row" style="gap:8px;">
        <button class="btn gradient large" id="payStripe">Pagar com Stripe</button>
        <button class="btn pill large" id="payMP">Pagar com Mercado Pago</button>
        <button class="btn ghost large" id="previewCert">Gerar certificado (Teste – sem pagamento)</button>
      </div>
    </div>
  </div>
</section>
<script>
  document.getElementById('payStripe').addEventListener('click', async () => {
    const nameEl = document.getElementById('student_name');
    const emailEl = document.getElementById('student_email');
    const name = (nameEl?.value || '').trim();
    const email = (emailEl?.value || '').trim();
    if (!name) { alert('Informe seu nome'); return; }
    if (!email) { alert('Informe seu e-mail'); return; }
    const res = await fetch('/payment/create-direct', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ courseId: <%= course.id %>, name, email })
    });
    const data = await res.json();
    if (data.url) { window.location.href = data.url; }
  });

  document.getElementById('payMP').addEventListener('click', async () => {
    const nameEl = document.getElementById('student_name');
    const emailEl = document.getElementById('student_email');
    const name = (nameEl?.value || '').trim();
    const email = (emailEl?.value || '').trim();
    if (!name) { alert('Informe seu nome'); return; }
    if (!email) { alert('Informe seu e-mail'); return; }
    const res = await fetch('/payment/create-direct-mp', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ courseId: <%= course.id %>, name, email })
    });
    const data = await res.json();
    if (data.url) { window.location.href = data.url; }
  });

  document.getElementById('previewCert').addEventListener('click', async () => {
    let name = (document.getElementById('student_name')?.value || 'Aluno Teste').trim();
    let email = (document.getElementById('student_email')?.value || `teste+${Date.now()}@example.com`).trim();
    const nameEl = document.getElementById('student_name');
    const emailEl = document.getElementById('student_email');
    if (nameEl && emailEl) {
      name = nameEl.value.trim() || name;
      email = emailEl.value.trim() || email;
    }
    const res = await fetch('/certificate/preview', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ courseId: <%= course.id %>, student_name: name, student_email: email, scorePercent: <%= typeof scorePercent !== 'undefined' ? scorePercent : 100 %> })
    });
    const data = await res.json();
    if (data.validateUrl) { window.location.href = data.validateUrl; }
    else if (data.pdfUrl) { window.location.href = data.pdfUrl; }
    else { alert('Não foi possível gerar o certificado de teste.'); }
  });
</script>